# MySQL查询优化
## 为什么要使用索引？
在不使用索引的情况，查询数据需要逐行扫描，在数据量很大的情况必然会很浪费时间。而使用索引后，通过索引能够得知匹配数据的位置，大大提高查询效率。
<div align=center>
  <img src="https://github.com/qinchunabng/ReadingNotes/blob/master/images/table_ad.png" alt="没有索引的数据表ad" title="没有索引的数据表ad"/>
  <p>没有索引的数据表ad</p>
</div>
上图是一个数据表ad，如果在没有索引的情况下，查找所有company_num为13的数据行，就需要检索表中所有的数据行，如果表很大但是仅有几个记录与搜索条件匹配，那么整个过程就很慢效率很低。但是我们如果在company_num列上建立一个索引，就不用再一行一行检索表中所有的数据行，如果查询company_num为13的行数，当搜索到company_num为14数据时，就知道后面已经没有company_num为13的数据了，这样就是提高检索效率。
这是单表查询的情况下，还有一种情况是多表联合查询，也可以通过索引的方式提高检索效率。单表里面在没有索引情况需求检索表里面所有数据行，也就是表的数据总行数，但是在多表联合查询的情况下，没有索引的情况检索的数据就是多个表中数据的笛卡尔积，这个数量将会是非常庞大的。举个栗子：假如有三个没有索引的表t1、t2和t3，且每个表中都有一列从1到1000的数据，要找出这些表所有具有相同数值所有数据行的组合，查询语句如下
<pre>
  <code>
    select * from t1 inner join t2 on t1.i1=t2.i2 inner join t2.i2=t3.i3
  </code>
</pre>
如果不用索引不全表扫面，就无法知道那些数据行包含有哪些数据。因此，必须组合所有的数据行来查找那些数据行与where字句匹配，这样的组合有1000x1000x1000种，比匹配的数据多100万倍，这是一种极大的浪费。使用索引后，查询过程将分为以下几个步骤：

1. 从数据表t1中选择第一行数据，看这个数据包含什么样的值；
2. 对数据表t2使用索引，直接找到与表t1相匹配的数据行，类似的表t3也是采用同样的操作；
3. 对数据表t1重复上面的过程，直到检查完t1表中的所有数据。

在这个例子中，虽然仍然对t1表进行了全表扫描，但是我们能对t2和t3表使用索引检索，直接将相应的数据行找出来，这种查询方式比不使用索引快100万倍。
## 索引使用方式有以下几种。
- 如上所述，索引的用途，一是在查询操作中把与WHERE子句中所给出的条件相匹配的数据行快速找出；二是关联查询中把其他表中相应的数据行快速找出。
- 对于使用MIN()或MAX()的函数查询，可以快速获取到相应值，而不用逐行检索的方式获取最大最小值。
- 使用索引快速完成ORDER BY子句和GROUP BY子句的排序和分组操作。
- 通过通过索引避免为一个整体查询数据行。假如你是查询MyISAM数据表的一个有索引的字段的值，在这种情况下，MySQL从这个索引文件读取索引值时，就已经得到了这个值，避免读取数据文件，减少了一次查询。
## 索引的缺点
- 首先，索引加快了查询速度，但是却降低了在有索引的数据里插入、删除、修改数据的速度。之所以出现这种情况，是因为写入一条数据，不仅要求将数据写入到数据行，还会改变当前的索引，一个表索引越多，写入操作也就越慢。
- 索引会占据磁盘空间，索引越多，占用的磁盘空间就越大。
  - 对于MyISAM类型数据表而言，大量的索引一个数据表，有可能导致索引文件比数据文件更快的达到它的最大值。
  - 存储在InnDB共享表空间里的全部InnoDB数据表分享着同一个存储空间，添加索引会使存储空间中用于数据存储的空间减少。和MyISAM不同，InnoDB共享表空间不受操作系统文件尺寸的大小限制，因为它可以包含多个文件。如果你有一个附加磁盘空间，你可以通过添加新的文件来扩充表空间。使用单独表空间的InnoDB数据表把数据文件和索引文件存在一个文件中，增加索引将导致文件大小更快的达到最大限制文件大小。

综上所述，如果不需要某个索引来加快查询速度，就不要创建它。
## 什么样的列适合建索引？
- 尽量为用来搜索、分类或分组的数据列创建索引，不要为作为输出的显示列创建索引。也就是说，最适合创建索引的数据列是那些WHERE子句中数据列、联结字句中的列，或者是在ORDER BY或GROUP BY子句中出现的列。
- 数据列中数据重复可能性的列。数据重复可能大的列不适合建索引，例如记录性别的列，取值“M”和“F”，这个时候建索引用处就不大，因为不管你查哪个值都可能找到板书左右的数据行。在这种情况下，索引或者根本就不会被使用，因为当查询优化程序确定某一个值在数据表的数据行中出现的频率超过30%时，查询优化会放弃使用索引，进行全表扫描。而现在的优化更复杂，会把其他因素也考虑进去，所以这个百分比已经不是MySQL是否使用索引的唯一依据。
- 应尽量选择比较小的数据类型建立索引。比如，如果一个MEDIUMINT数据列已足以容纳你的数据，就不要使用BIGINT。
